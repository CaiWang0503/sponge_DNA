---
title: "Untitled"
author: "cai wang"
date: "14/10/2021"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(phyloseq)
```

```{r separate sequnce}
OTUseq<-read.csv("spongetank_all_SWARM_FINAL_OTU_20211011.csv", header=TRUE)
seq<-apply(OTUseq, 1, function(x){paste0(">",x[1],"\n",x[121])})
writeLines(seq)
write.table(seq,file="spongetank_all_SWARM_FINAL_OTU.fasta",row.names = F,quote=F)
#delete x
OTUtab<-OTUseq %>% select (D1.SW.BLANK:LIB02.PCR.Pos.03)
rownames(OTUtab)=OTUseq$id
```

```{r code for LuLu (use to fiter ech OTU), eval=FALSE }
#1.#filter echo OTU
##terminal##vsearch --usearch_global spongetank_all_SWARM_FINAL_OTU.fasta --db spongetank_all_SWARM_FINAL_OTU.fasta --self --id .84 --iddef 1 --userout match_list.txt -userfields query+target+id --maxaccepts 0 --query_cov .9 --maxhits 10 
#install.packages("devtools")
#library(devtools)
#install_github("tobiasgf/lulu") 
library(lulu)
matchlist <- read.table("match_list.txt", header=FALSE,as.is=TRUE, stringsAsFactors=FALSE)

curated_result <- lulu(OTUtab, matchlist, minimum_ratio_type = "min", minimum_ratio = 1, minimum_match = 84, minimum_relative_cooccurence = 0.95)
#compare the result
#curated_result$curated_table
#curated_result$original_table
curated_result$discarded_coun
OTUtax <-OTUseq[OTUseq$id %in% rownames(curated_result$curated_table),]
write.csv(OTUtax, file = "spongetank_SWARM_OTU_LULU_FULL_20211014.csv",row.names = TRUE, quote = FALSE)
#write.csv(curated_result$curated_table, file = "spongetank_SWARM_OTU_LULU_20211014.csv",row.names = TRUE, quote = FALSE)
rm(list=ls())
```

```{r collapse OTUs on terminal}
#collapse MOTUs on terminal
#Rscript /Users/wang/Desktop/ob1_mbc/R_scripts_metabarpark/owi_collapse -s 16 -e 116 -t 0.50 -i spongetank_SWARM_OTU_LULU_FULL_20211014.csv
#-s 14 Sample columns start; -e sample columns end. Default = 98; -t 0.50 Threshold for collapsing
```

```{r phyloseq formal}
OTUseq<-read.csv("spongetank_SWARM_OTU_LULU_FULL_20211014_collapsed.csv", header=TRUE)
#otu_table
OTU<-OTUseq %>% select (D1.SW.BLANK:LIB02.PCR.Pos.03)
rownames(OTU)=OTUseq$id
OTU <- as.matrix(OTU)

#tax_table
TAX<-OTUseq %>% select (kingdom_name:species_name)
rownames(TAX)=OTUseq$id
TAX <- as.matrix(TAX)
#sample_data
sampledata= data.frame(colnames=colnames(OTU))
sampledata$colnames=as.character(sampledata$colnames)
write.table(sampledata,file="sampledata.txt",row.names = F,quote=F)


physeq_spongetank = phyloseq(OTU, TAX, sampledata)
```

```{r}
ps <- readRDS(system.file("extdata", "MUClite.rds", package="decontam"))
head(sample_data(ps))
contamdf.freq <- isContaminant(ps, method="frequency", conc="quant_reading")
```

